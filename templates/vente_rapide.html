{% extends 'layout.html' %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
    
    * {
        font-family: 'Poppins', sans-serif;
    }
    
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    .vente-rapide-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* ===== HEADER STATS DIVIN ===== */
    .stats-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 25px;
        margin-bottom: 25px;
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
        position: relative;
        overflow: hidden;
    }
    
    .stats-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: pulse-glow 4s ease-in-out infinite;
    }
    
    @keyframes pulse-glow {
        0%, 100% { transform: scale(1); opacity: 0.3; }
        50% { transform: scale(1.1); opacity: 0.6; }
    }
    
    .stats-item {
        text-align: center;
        position: relative;
        z-index: 1;
    }
    
    .stats-number {
        font-size: 3.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 5px 15px rgba(0,0,0,0.3);
        animation: count-up 0.5s ease-out;
    }
    
    @keyframes count-up {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .stats-label {
        font-size: 1rem;
        opacity: 0.95;
        font-weight: 300;
        letter-spacing: 1px;
    }
    
    .stats-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        opacity: 0.8;
    }
    
    /* ===== SECTION PRINCIPALE ===== */
    .main-section {
        background: white;
        border-radius: 30px;
        padding: 30px;
        box-shadow: 0 30px 90px rgba(0,0,0,0.15);
    }
    
    /* ===== BARRE DE RECHERCHE DIVINE ===== */
    .search-box {
        margin-bottom: 25px;
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 18px 60px 18px 25px;
        font-size: 1.1rem;
        border: 3px solid #e8ecf4;
        border-radius: 20px;
        transition: all 0.3s ease;
        background: #f8f9fc;
    }
    
    .search-input:focus {
        border-color: #667eea;
        outline: none;
        background: white;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }
    
    .search-icon {
        position: absolute;
        right: 25px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.5rem;
        color: #667eea;
    }
    
    /* ===== GRILLE PRODUITS DIVINE ===== */
    .produit-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .produit-card {
        background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
        border: 3px solid transparent;
        border-radius: 20px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    .produit-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .produit-card:hover {
        border-color: #667eea;
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 20px 50px rgba(102, 126, 234, 0.4);
    }
    
    .produit-card:hover::before {
        opacity: 0.1;
    }
    
    .produit-card.selected {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        animation: select-bounce 0.5s ease;
    }
    
    @keyframes select-bounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    .produit-card:active {
        transform: scale(0.95);
    }
    
    .produit-nom {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
        position: relative;
        z-index: 1;
    }
    
    .produit-prix {
        font-size: 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        position: relative;
        z-index: 1;
    }
    
    /* ===== PANIER DIVIN ===== */
    .panier-section {
        background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        position: sticky;
        top: 20px;
        border: 3px solid #e8ecf4;
    }
    
    .panier-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 3px solid #e8ecf4;
    }
    
    .panier-icon {
        font-size: 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .panier-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }
    
    .panier-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: white;
        border-radius: 15px;
        margin-bottom: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        animation: slide-in 0.3s ease;
    }
    
    @keyframes slide-in {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .panier-item:hover {
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        transform: translateX(5px);
    }
    
    .panier-item-nom {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.05rem;
    }
    
    .panier-item-prix {
        color: #7f8c8d;
        font-size: 0.95rem;
        margin-top: 3px;
    }
    
    .panier-item-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .qty-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 1.4rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .qty-btn:hover {
        transform: scale(1.1) rotate(10deg);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }
    
    .qty-btn:active {
        transform: scale(0.9);
    }
    
    .qty-display {
        font-size: 1.3rem;
        font-weight: 700;
        min-width: 35px;
        text-align: center;
        color: #2c3e50;
    }
    
    /* ===== TOTAL DIVIN ===== */
    .panier-total {
        border-top: 3px solid #e8ecf4;
        padding-top: 20px;
        margin-top: 20px;
    }
    
    .total-label {
        font-size: 1.2rem;
        color: #7f8c8d;
        font-weight: 600;
        letter-spacing: 2px;
    }
    
    .total-montant {
        font-size: 3rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 15px 0;
        text-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }
    
    /* ===== MONTANT RE√áU ===== */
    .montant-recu-section {
        margin: 25px 0;
    }
    
    .montant-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    
    .montant-input {
        width: 100%;
        padding: 18px;
        font-size: 1.8rem;
        font-weight: 700;
        border: 3px solid #e8ecf4;
        border-radius: 15px;
        text-align: center;
        transition: all 0.3s ease;
        background: #f8f9fc;
    }
    
    .montant-input:focus {
        border-color: #667eea;
        outline: none;
        background: white;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.2);
    }
    
    /* ===== RENDU DIVIN ===== */
    .rendu-section {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
        border: 3px solid #28a745;
        box-shadow: 0 10px 30px rgba(40, 167, 69, 0.2);
    }
    
    .rendu-label {
        font-size: 1.1rem;
        color: #155724;
        font-weight: 600;
        margin-bottom: 8px;
        letter-spacing: 1px;
    }
    
    .rendu-montant {
        font-size: 3.5rem;
        font-weight: 700;
        color: #28a745;
        text-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        animation: pulse-rendu 1s ease infinite;
    }
    
    @keyframes pulse-rendu {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    /* ===== BOUTONS DIVINS ===== */
    .btn-valider {
        width: 100%;
        padding: 22px;
        font-size: 1.6rem;
        font-weight: 700;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        border-radius: 18px;
        color: white;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 15px 40px rgba(40, 167, 69, 0.4);
        position: relative;
        overflow: hidden;
    }
    
    .btn-valider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255,255,255,0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }
    
    .btn-valider:hover::before {
        width: 300px;
        height: 300px;
    }
    
    .btn-valider:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 60px rgba(40, 167, 69, 0.6);
    }
    
    .btn-valider:active {
        transform: translateY(-2px);
    }
    
    .btn-valider:disabled {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        cursor: not-allowed;
        box-shadow: none;
    }
    
    .btn-clear {
        width: 100%;
        padding: 15px;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border: none;
        border-radius: 15px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
    }
    
    .btn-clear:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(231, 76, 60, 0.5);
    }
    
    /* ===== MODAL DIVIN ===== */
    .success-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.7);
        background: white;
        padding: 50px;
        border-radius: 30px;
        box-shadow: 0 30px 90px rgba(0,0,0,0.3);
        z-index: 1000;
        text-align: center;
        min-width: 450px;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .success-modal.show {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
    
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .modal-overlay.show {
        display: block;
        opacity: 1;
    }
    
    .success-icon {
        font-size: 6rem;
        color: #28a745;
        margin-bottom: 25px;
        animation: bounce-in 0.6s ease;
    }
    
    @keyframes bounce-in {
        0% { transform: scale(0) rotate(-180deg); }
        50% { transform: scale(1.2) rotate(10deg); }
        100% { transform: scale(1) rotate(0); }
    }
    
    .modal-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 20px;
    }
    
    .modal-details {
        background: #f8f9fc;
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
    }
    
    .modal-details strong {
        color: #667eea;
    }
    
    /* ===== PANIER VIDE ===== */
    .panier-vide {
        text-align: center;
        padding: 40px 20px;
        color: #95a5a6;
    }
    
    .panier-vide-icon {
        font-size: 4rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .produit-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stats-number {
            font-size: 2.5rem;
        }
        
        .total-montant {
            font-size: 2.5rem;
        }
        
        .rendu-montant {
            font-size: 2.5rem;
        }
        
        .success-modal {
            min-width: 90%;
            padding: 30px;
        }
    }
</style>

<div class="vente-rapide-container">
    <!-- Stats Header Divine -->
    <div class="stats-header">
        <div class="row">
            <div class="col-md-4 stats-item">
                <div class="stats-icon">üéØ</div>
                <p class="stats-number" id="nb-ventes">{{ stats_jour['nb_ventes'] }}</p>
                <p class="stats-label">VENTES AUJOURD'HUI</p>
            </div>
            <div class="col-md-4 stats-item">
                <div class="stats-icon">üí∞</div>
                <p class="stats-number" id="total-jour">{{ "{:,.0f}".format(stats_jour['total_jour']) }} F</p>
                <p class="stats-label">TOTAL DU JOUR</p>
            </div>
            <div class="col-md-4 stats-item">
                <div class="stats-icon">‚è∞</div>
                <p class="stats-number" id="heure-actuelle">--:--</p>
                <p class="stats-label">HEURE ACTUELLE</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Section Produits -->
        <div class="col-lg-8">
            <div class="main-section">
                <div class="search-box">
                    <input type="text" 
                           class="search-input" 
                           id="search-produit" 
                           placeholder="Rechercher un produit...">
                    <span class="search-icon">üîç</span>
                </div>
                
                <div class="produit-grid" id="produit-grid">
                    {% for produit in produits %}
                    <div class="produit-card" 
                         data-id="{{ produit['id'] }}"
                         data-nom="{{ produit['nom'] }}"
                         data-prix="{{ produit['prix_suggere'] }}">
                        <div class="produit-nom">{{ produit['nom'] }}</div>
                        <div class="produit-prix">{{ "{:,.0f}".format(produit['prix_suggere']) }} F</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Section Panier -->
        <div class="col-lg-4">
            <div class="panier-section">
                <div class="panier-header">
                    <span class="panier-icon">üõí</span>
                    <h3 class="panier-title">PANIER</h3>
                </div>
                
                <div id="panier-items">
                    <div class="panier-vide">
                        <div class="panier-vide-icon">üõçÔ∏è</div>
                        <p>Aucun produit s√©lectionn√©</p>
                    </div>
                </div>
                
                <div class="panier-total">
                    <div class="total-label">TOTAL</div>
                    <div class="total-montant" id="total-panier">0 F</div>
                </div>
                
                <div class="montant-recu-section">
                    <label class="montant-label">üíµ Montant re√ßu</label>
                    <input type="number" 
                           class="montant-input" 
                           id="montant-recu" 
                           placeholder="0">
                </div>
                
                <div class="rendu-section" id="rendu-section" style="display: none;">
                    <div class="rendu-label">üí∏ √Ä RENDRE</div>
                    <div class="rendu-montant" id="rendu-montant">0 F</div>
                </div>
                
                <button class="btn-clear" id="btn-clear">üóëÔ∏è Vider le panier</button>
                <button class="btn-valider" id="btn-valider" disabled>
                    ‚ú® VALIDER LA VENTE ‚ú®
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de succ√®s Divine -->
<div class="modal-overlay" id="modal-overlay" onclick="fermerModal()"></div>
<div class="success-modal" id="success-modal">
    <div class="success-icon">‚úÖ</div>
    <h2 class="modal-title">Vente Enregistr√©e !</h2>
    <div class="modal-details">
        <p style="font-size: 1.3rem; margin: 10px 0;">
            <strong>Total:</strong> <span id="modal-total" style="font-size: 1.5rem;"></span>
        </p>
        <p style="font-size: 1.3rem; margin: 10px 0;">
            <strong>Rendu:</strong> <span id="modal-rendu" style="font-size: 1.5rem; color: #28a745;"></span>
        </p>
    </div>
    <button class="btn btn-primary btn-lg mt-3" onclick="fermerModal()" style="min-width: 200px; font-size: 1.2rem; padding: 15px; border-radius: 15px;">
        üîÑ Nouvelle vente
    </button>
    <a class="btn btn-secondary btn-lg mt-3" id="btn-imprimer" href="#" target="_blank" style="min-width: 200px; font-size: 1.2rem; padding: 15px; border-radius: 15px;">
        üñ®Ô∏è Imprimer
    </a>
</div>

<script>
// Configuration
let panier = [];
let total = 0;

// Sons de notification (optionnel - peut √™tre d√©sactiv√©)
function playSound(type) {
    // Vous pouvez ajouter des sons ici si vous le souhaitez
    // Pour l'instant, c'est d√©sactiv√©
}

// Mettre √† jour l'heure
function updateHeure() {
    const now = new Date();
    document.getElementById('heure-actuelle').textContent = 
        now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
}
updateHeure();
setInterval(updateHeure, 10000); // Toutes les 10 secondes

// Formater les nombres avec espaces
function formatMontant(montant) {
    return montant.toLocaleString('fr-FR') + ' F';
}

// Ajouter un produit au panier
document.querySelectorAll('.produit-card').forEach(card => {
    card.addEventListener('click', function() {
        const id = parseInt(this.dataset.id);
        const nom = this.dataset.nom;
        const prix = parseFloat(this.dataset.prix);
        
        if (prix <= 0) {
            alert('‚ö†Ô∏è Veuillez d√©finir un prix pour ce produit d\'abord');
            return;
        }
        
        // V√©rifier si le produit existe d√©j√†
        const existant = panier.find(item => item.produit_id === id);
        
        if (existant) {
            existant.quantite++;
        } else {
            panier.push({
                produit_id: id,
                nom: nom,
                prix: prix,
                quantite: 1
            });
        }
        
        // Animation de s√©lection
        this.classList.add('selected');
        setTimeout(() => this.classList.remove('selected'), 500);
        
        afficherPanier();
    });
});

// Afficher le panier
function afficherPanier() {
    const panierDiv = document.getElementById('panier-items');
    
    if (panier.length === 0) {
        panierDiv.innerHTML = `
            <div class="panier-vide">
                <div class="panier-vide-icon">üõçÔ∏è</div>
                <p>Aucun produit s√©lectionn√©</p>
            </div>
        `;
        total = 0;
    } else {
        panierDiv.innerHTML = panier.map((item, index) => `
            <div class="panier-item">
                <div class="panier-item-info">
                    <div class="panier-item-nom">${item.nom}</div>
                    <div class="panier-item-prix">${formatMontant(item.prix)} √ó ${item.quantite}</div>
                </div>
                <div class="panier-item-controls">
                    <button class="qty-btn" onclick="modifierQty(${index}, -1)" title="Diminuer">‚àí</button>
                    <span class="qty-display">${item.quantite}</span>
                    <button class="qty-btn" onclick="modifierQty(${index}, 1)" title="Augmenter">+</button>
                </div>
            </div>
        `).join('');
        
        total = panier.reduce((sum, item) => sum + (item.prix * item.quantite), 0);
    }
    
    document.getElementById('total-panier').textContent = formatMontant(total);
    document.getElementById('btn-valider').disabled = panier.length === 0;
    
    calculerRendu();
}

// Modifier la quantit√©
function modifierQty(index, delta) {
    panier[index].quantite += delta;
    
    if (panier[index].quantite <= 0) {
        panier.splice(index, 1);
    }
    
    afficherPanier();
}

// Calculer le rendu
function calculerRendu() {
    const montantRecu = parseFloat(document.getElementById('montant-recu').value) || 0;
    const rendu = montantRecu - total;
    const renduSection = document.getElementById('rendu-section');
    const renduMontant = document.getElementById('rendu-montant');
    
    if (montantRecu > 0) {
        renduSection.style.display = 'block';
        if (rendu >= 0) {
            renduMontant.textContent = formatMontant(rendu);
            renduMontant.style.color = '#28a745';
            renduSection.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
            renduSection.style.borderColor = '#28a745';
        } else {
            renduMontant.textContent = '‚ö†Ô∏è Montant insuffisant';
            renduMontant.style.color = '#dc3545';
            renduSection.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
            renduSection.style.borderColor = '#dc3545';
        }
    } else {
        renduSection.style.display = 'none';
    }
}

document.getElementById('montant-recu').addEventListener('input', calculerRendu);

// Vider le panier
document.getElementById('btn-clear').addEventListener('click', function() {
    if (panier.length === 0) return;
    
    if (confirm('üóëÔ∏è Vider le panier ?')) {
        panier = [];
        afficherPanier();
        document.getElementById('montant-recu').value = '';
        calculerRendu();
    }
});

// Valider la vente
document.getElementById('btn-valider').addEventListener('click', async function() {
    if (panier.length === 0) return;
    
    const montantRecu = parseFloat(document.getElementById('montant-recu').value) || 0;
    const rendu = montantRecu - total;
    
    // V√©rifier que le montant est suffisant
    if (montantRecu > 0 && rendu < 0) {
        alert('‚ö†Ô∏è Le montant re√ßu est insuffisant !');
        return;
    }
    
    // D√©sactiver le bouton et changer le texte
    this.disabled = true;
    const originalText = this.textContent;
    this.textContent = '‚è≥ Enregistrement en cours...';
    
    try {
        const response = await fetch('/api/vente_rapide', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                panier: panier,
                nom_client: 'Client passant',
                montant_recu: montantRecu
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Afficher modal de succ√®s
            document.getElementById('modal-total').textContent = formatMontant(data.total);
            document.getElementById('modal-rendu').textContent = formatMontant(data.rendu);
            document.getElementById('btn-imprimer').href = `/recu/${data.recu_id}/imprimer`;
            
            document.getElementById('modal-overlay').classList.add('show');
            document.getElementById('success-modal').classList.add('show');
            
            // Mettre √† jour les stats
            updateStats();
            
            // R√©initialiser le panier
            panier = [];
            afficherPanier();
            document.getElementById('montant-recu').value = '';
            calculerRendu();
        } else {
            alert('‚ùå Erreur: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Erreur de connexion. V√©rifiez votre connexion internet.');
        console.error(error);
    }
    
    this.disabled = false;
    this.textContent = originalText;
});

// Fermer modal
function fermerModal() {
    document.getElementById('modal-overlay').classList.remove('show');
    document.getElementById('success-modal').classList.remove('show');
}

// Recherche de produits
document.getElementById('search-produit').addEventListener('input', function() {
    const terme = this.value.toLowerCase().trim();
    const cards = document.querySelectorAll('.produit-card');
    
    cards.forEach(card => {
        const nom = card.dataset.nom.toLowerCase();
        if (nom.includes(terme)) {
            card.style.display = 'flex';
            card.style.animation = 'slide-in 0.3s ease';
        } else {
            card.style.display = 'none';
        }
    });
    
    // Si recherche vide, tout afficher
    if (terme === '') {
        cards.forEach(card => {
            card.style.display = 'flex';
        });
    }
});

// Mettre √† jour les stats
async function updateStats() {
    try {
        const response = await fetch('/api/stats_jour');
        const data = await response.json();
        
        // Animation des chiffres
        animateValue('nb-ventes', parseInt(document.getElementById('nb-ventes').textContent) || 0, data.nb_ventes, 500);
        animateValue('total-jour', 
            parseFloat(document.getElementById('total-jour').textContent.replace(/[^\d]/g, '')) || 0, 
            data.total_jour, 
            500,
            true
        );
    } catch (error) {
        console.error('Erreur stats:', error);
    }
}

// Animer les valeurs num√©riques
function animateValue(id, start, end, duration, isMontant = false) {
    const element = document.getElementById(id);
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
        }
        
        if (isMontant) {
            element.textContent = Math.round(current).toLocaleString('fr-FR') + ' F';
        } else {
            element.textContent = Math.round(current);
        }
    }, 16);
}

// Raccourcis clavier
document.addEventListener('keydown', function(e) {
    // Entr√©e = Valider (si le bouton est actif)
    if (e.key === 'Enter' && !document.getElementById('btn-valider').disabled) {
        e.preventDefault();
        document.getElementById('btn-valider').click();
    }
    
    // √âchap = Vider le panier
    if (e.key === 'Escape') {
        e.preventDefault();
        document.getElementById('btn-clear').click();
    }
    
    // Ctrl/Cmd + K = Focus recherche
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('search-produit').focus();
    }
});

// Auto-focus sur le montant re√ßu quand le panier n'est pas vide
setInterval(() => {
    if (panier.length > 0 && document.getElementById('montant-recu').value === '') {
        document.getElementById('montant-recu').focus();
    }
}, 3000);

// Mise √† jour automatique des stats toutes les 30 secondes
setInterval(updateStats, 30000);

// Message de bienvenue
console.log('%c‚ö° VENTE RAPIDE ACTIV√âE ‚ö°', 'font-size: 20px; font-weight: bold; color: #667eea;');
console.log('%cRaccourcis: Entr√©e = Valider | √âchap = Vider | Ctrl+K = Recherche', 'color: #7f8c8d;');
</script>

{% endblock %}